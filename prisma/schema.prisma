
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  
}


model Category {
  id               Int              @id @default(autoincrement())
  name             String           @unique
  middleCategories MiddleCategory[]
  products         product[] // Ana kategori bazlı filtreleme için
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@map("category")
}

model MiddleCategory {
  id            Int           @id @default(autoincrement())
  name          String
  categoryId    Int
  category      Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subCategories SubCategory[]
  products      product[] // Orta kategori bazlı filtreleme için
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([name, categoryId])
  @@map("middle_category")
}

model SubCategory {
  id               Int            @id @default(autoincrement())
  name             String
  middleCategoryId Int
  middleCategory   MiddleCategory @relation(fields: [middleCategoryId], references: [id], onDelete: Cascade)
  products         product[] // En alt seviye ürünler
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([name, middleCategoryId])
  @@map("sub_category")
}

// --- ÜRÜN MODELİ ---

model product {
  id                 Int     @id @default(autoincrement())
  title              String
  price              Int
  oldPrice           Int?
  discountPercentage Int?
  rating             Int     @default(0)
  reviewCount        Int?    @default(0)
  mainImage          String  @default("default-image.jpg")
  subImage           String?
  subImage2          String?
  subImage3          String?
  subImage4          String?
  description        String  @db.Text

  // Hiyerarşik İlişkiler
  categoryId       Int
  category         Category        @relation(fields: [categoryId], references: [id])
  middleCategoryId Int?
  middleCategory   MiddleCategory? @relation(fields: [middleCategoryId], references: [id])
  subCategoryId    Int?
  subCategory      SubCategory?    @relation(fields: [subCategoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Diğer Modellerle İlişkiler
  CartItem  CartItem[]
  Favorite  Favorite[]
  OrderItem OrderItem[]
  Review    Review[]
}

// --- KULLANICI VE ADRES SİSTEMİ ---

model User {
  id                Int        @id @default(autoincrement())
  name              String
  surname           String
  email             String     @unique
  password          String
  phone             String?
  role              UserRole   @default(USER)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  resetToken        String?
  resetTokenExpires DateTime?
  addresses         Address[]
  favorites         Favorite[]
  orders            Order[]
  Review            Review[]

  @@map("user")
}

model Address {
  id           Int      @id @default(autoincrement())
  userId       Int
  title        String
  firstName    String
  lastName     String
  address      String
  neighborhood String?
  district     String
  city         String
  tcno         String?  @db.VarChar(11)
  zip          String
  phone        String
  country      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Address_userId_fkey")
  @@map("address")
}

// --- SEPET VE FAVORİLER ---

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  createdAt DateTime @default(now())
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId], map: "Favorite_productId_fkey")
  @@map("favorite")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int?
  productId Int
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "CartItem_productId_fkey")
  @@map("cartitem")
}

// --- SİPARİŞ SİSTEMİ ---

model Order {
  id             Int            @id @default(autoincrement())
  userId         Int
  status         OrderStatus    @default(pending)
  totalPrice     Int
  paidPrice      Int
  currency       String
  installment    Int            @default(1)
  iyziPaymentId  String?
  paymentMethod  String
  transactionId  String?
  couponCode     String?
  discountAmount Float?         @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses      OrderAddress[]
  items          OrderItem[]

  @@index([userId], map: "Order_userId_fkey")
  @@index([couponCode], map: "Order_couponCode_idx")
  @@map("order")
}

model OrderItem {
  id                Int     @id @default(autoincrement())
  orderId           Int
  productId         Int
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  iyziTransactionId String?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product product @relation(fields: [productId], references: [id])

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
  @@map("orderitem")
}

model OrderAddress {
  id        Int     @id @default(autoincrement())
  orderId   Int
  type      String
  firstName String
  lastName  String
  address   String
  district  String
  tcno      String? @db.VarChar(11)
  city      String
  zip       String
  phone     String
  country   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "OrderAddress_orderId_fkey")
  @@map("orderaddress")
}

// --- DİĞER MODELLER ---

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  title     String?
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  userId    Int
  productId Int
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId], map: "Review_productId_fkey")
  @@map("review")
}

model Blog {
  id        Int      @id @default(autoincrement())
  title     String
  content   String   @db.Text
  image     String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog")
}

model Subscribe {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscribe")
}

model Banner {
  id       Int     @id @default(autoincrement())
  title    String?
  subtitle String?
}

model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  type        CouponType
  value       Float
  minAmount   Float?
  maxDiscount Float?
  isActive    Boolean    @default(true)
  usageLimit  Int?
  usedCount   Int        @default(0)
  expiryDate  DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([code], map: "Coupon_code_idx")
  @@index([isActive], map: "Coupon_isActive_idx")
  @@map("coupons")
}

// --- ENUMLAR ---

enum CouponType {
  PERCENTAGE
  FIXED
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum UserRole {
  USER
  ADMIN
}
